<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Passport Power Calculator</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; color:#333; margin:0; padding:0; }
    header { background:#e0e0e0; border-bottom:1px solid #aaa; padding:12px 20px; text-align:center; }
    header h1 { margin:0; font-size:1.4em; font-weight:normal; }

    .container {
      display:grid;
      grid-template-columns: 360px 5px 1fr; /* LEFT | V DIV | RIGHT  */
      grid-template-rows: 220px 5px 1fr;    /* NOTES | H DIV | RESULTS */
      height: calc(100vh - 50px);
    }

    .countries {
      grid-column:1; grid-row:1 / span 3;
      border-right:1px solid #aaa; padding:10px; overflow-y:auto; background:#eee;
      display:flex; flex-direction:column;
    }
    .notes {
      grid-column:3; grid-row:1;
      padding:10px; background:#fafafa; border-bottom:1px solid #ddd; box-shadow: inset 0 1px 0 #fff;
    }

    /* ADD: small circular flag/avatar beside country name */
.flag {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  margin-right: 8px;
  vertical-align: -3px;
  object-fit: cover;
  border: 1px solid #aaa;
  background: #fff;
}
.country-button input { margin-right: 6px; } /* keep as-is, works with the flag */

    .results {
      grid-column:3; grid-row:3;
      padding:10px; overflow-y:auto; background:#fff; border-top:1px solid #eee;
    }

    h2 { font-size:1.1em; margin-top:0; border-bottom:1px solid #ccc; padding-bottom:5px; }

    .search-box { margin-bottom:10px; }
    .search-box input {
      width:100%; padding:8px; border:1px solid #aaa; border-radius:4px; font-size:0.9em;
      background:#fafafa; box-sizing:border-box;
    }

    .country-list { list-style:none; padding:0; margin:0; flex-grow:1; }
    .country-list li { margin-bottom:8px; }
    .country-button {
      display:block; width:100%; background:#ddd; border:1px solid #aaa; border-radius:6px;
      padding:8px; text-align:left; cursor:pointer; font-size:0.95em; transition:background .2s, transform .1s;
      box-sizing:border-box;
    }
    .country-button:hover { background:#ccc; }
    .country-button:active { transform:scale(0.98); }
    .country-button input { margin-right:6px; }
    .disabled { color:#999; pointer-events:none; opacity:.6; }

    .drag-bar { background:#ccc; user-select:none; transition:background .15s; }
    .drag-bar:hover { background:#bdbdbd; }
    #drag-bar-x { grid-column:2; grid-row:1 / span 3; cursor:col-resize; width:5px; }
    #drag-bar-y { grid-column:3; grid-row:2; cursor:row-resize; height:5px;
      background-image: linear-gradient(to right, transparent 0, rgba(0,0,0,0.07) 50%, transparent 100%);
    }

    .pill { display:inline-block; padding:2px 6px; border:1px solid #bbb; border-radius:12px; background:#eee; margin:2px 4px 0 0; font-size:.85em; }
    .muted { color:#555; }
    .list-grid { columns: 2 280px; column-gap: 20px; }
    .list-grid li { break-inside: avoid; }

    * { scrollbar-width:thin; scrollbar-color:#bbb #eee; }
    *::-webkit-scrollbar { width:10px; height:10px; }
    *::-webkit-scrollbar-thumb { background:#bbb; border:2px solid #eee; border-radius:8px; }
    *::-webkit-scrollbar-track { background:#eee; }
  </style>
</head>
<body>
  <header>
    <h1>Passport Power Calculator</h1>
  </header>

  <div class="container" id="grid">
    <!-- LEFT: Countries -->
    <div class="countries">
      <h2>Countries</h2>
      <div class="search-box">
        <input type="text" id="search" placeholder="Search countries..." aria-label="Search countries">
      </div>
      <ul class="country-list" id="country-list"><!-- rendered dynamically --></ul>
    </div>

    <!-- Vertical drag -->
    <div class="drag-bar" id="drag-bar-x" role="separator" aria-orientation="vertical" tabindex="0" title="Drag to resize columns"></div>

    <!-- Top Right: Notes -->
    <div class="notes">
      <h2>Notes</h2>
      <div id="notes-content" class="muted">
        Select one or more passports on the left to see rules and travel privileges.
      </div>
    </div>

    <!-- Horizontal drag -->
    <div class="drag-bar" id="drag-bar-y" role="separator" aria-orientation="horizontal" tabindex="0" title="Drag to resize rows"></div>

    <!-- Bottom Right: Results -->
    <div class="results">
      <h2>Visa-Free Access</h2>
      <div id="summary"><b>0</b> countries available.</div>
      <div id="selected" class="muted" style="margin:6px 0 10px 0;"></div>
      <ul id="destinations" class="list-grid"><!-- destinations --></ul>
    </div>
  </div>

  <script>
  (function() {
    /* ===================== DATA LAYER ===================== */
    const PASSPORTS = new Map(); // code -> object
    const ORDER = [];            // preserve insertion order

    /* ADD (above addCountry): code â†’ display name registry for destinations not in PASSPORTS */
const CODE_TO_NAME = {}; // e.g. CODE_TO_NAME['GB'] = 'United Kingdom'
function registerName(code, name) {
  if (!code) return;
  CODE_TO_NAME[code.toUpperCase()] = name || code.toUpperCase();
}

/* REPLACE: addCountry now accepts visaFree as codes, plus optional alpha2/flag */
function addCountry({
  code,            // primary code for this passport (e.g., 'USA' or 'GB')
  name,            // display name ('United States')
  alpha2 = null,   // optional alpha-2 for flag files (e.g., 'US', 'GB')
  flag = null,     // optional explicit flag URL; if omitted and alpha2 exists: /flags/{alpha2}.png
  visaFree = [],   // ARRAY OF CODES NOW (e.g., ['CA','MX','GB','FR'])
  incompatibleWith = [], // ARRAY OF CODES (passport codes)
  maxCitizenships = Infinity,
  notes = ''
}) {
  const c = (code || '').trim().toUpperCase();
  if (!c || !name) return;

  const a2 = alpha2 ? alpha2.trim().toUpperCase() : null;
  const flagUrl = flag || (a2 ? `/flags/${a2.toLowerCase()}.png` : null);

  PASSPORTS.set(c, {
    code: c,
    name,
    alpha2: a2,
    flag: flagUrl,
    // store visa-free as uppercased codes for speed/consistency
    visaFree: new Set((visaFree || []).map(x => (x || '').toUpperCase())),
    incompatibleWith: new Set((incompatibleWith || []).map(x => (x || '').toUpperCase())),
    maxCitizenships: (Number.isFinite(maxCitizenships) ? maxCitizenships : Infinity),
    notes
  });
  ORDER.push(c);

  // Register this passport's own display name under BOTH its main code and alpha2 (if provided)
  registerName(c, name);
  if (a2) registerName(a2, name);
}

    // Symmetrize incompatibilities only (no DOM access here)
    function finalizeCountries() {
      for (const [code, obj] of PASSPORTS) {
        for (const other of obj.incompatibleWith) {
          const o = PASSPORTS.get(other);
          if (o) o.incompatibleWith.add(code);
        }
      }
    }

    /* ===== Sample entries (replace with your real lists) ===== */
    addCountry({
  code: 'AF', name: 'Afghanistan', alpha2: 'AF',
  visaFree: ['CA','MX','GB','FR','DE','JP','KR','SG']
});
    finalizeCountries();

    /* ===================== DOM & LOGIC ===================== */
    document.addEventListener('DOMContentLoaded', () => {
      const grid = document.getElementById('grid');
      const listEl = document.getElementById('country-list');
      const searchEl = document.getElementById('search');

      const notesEl = document.getElementById('notes-content');
      const summaryEl = document.getElementById('summary');
      const selectedEl = document.getElementById('selected');
      const destEl = document.getElementById('destinations');

      const selected = new Set();

      function renderCountryList() {
  listEl.innerHTML = '';
  for (const code of ORDER) {
    const p = PASSPORTS.get(code);
    const li = document.createElement('li');
    li.setAttribute('data-name', p.name.toLowerCase());
    li.setAttribute('data-code', p.code);

    const label = document.createElement('label');
    label.className = 'country-button';
    label.tabIndex = 0;

    // ADD: small circular image (flag or generic)
    if (p.flag) {
      const img = document.createElement('img');
      img.className = 'flag';
      img.src = p.flag;
      img.alt = `${p.name} flag`;
      label.appendChild(img);
    }

    const input = document.createElement('input');
    input.type = 'checkbox';
    input.value = p.code;
    input.addEventListener('change', onToggle);

    label.appendChild(input);
    label.append(p.name);

    li.appendChild(label);
    listEl.appendChild(li);
  }
}

      function onToggle(e) {
        const code = e.target.value;
        if (e.target.checked) selected.add(code);
        else selected.delete(code);
        recompute();
      }

      function currentMaxAllowedCount(withCandidate = null) {
        let minCap = Infinity;
        for (const c of selected) minCap = Math.min(minCap, PASSPORTS.get(c).maxCitizenships);
        if (withCandidate) minCap = Math.min(minCap, PASSPORTS.get(withCandidate).maxCitizenships);
        return minCap;
      }

      function isCompatibleToAdd(code) {
        const cand = PASSPORTS.get(code);
        if (!cand) return false;

        const minCap = currentMaxAllowedCount(code);
        if ((selected.size + 1) > minCap) return false;

        for (const s of selected) {
          const sel = PASSPORTS.get(s);
          if (sel.incompatibleWith.has(cand.code) || cand.incompatibleWith.has(sel.code)) return false;
        }
        return true;
      }

      function explainDisabledReasons() {
        const lines = [];
        const cap = currentMaxAllowedCount();
        if (cap !== Infinity) {
          const capping = Array.from(selected).filter(c => PASSPORTS.get(c).maxCitizenships === cap)
                               .map(c => PASSPORTS.get(c).name);
          lines.push(cap === 1
            ? `Citizenship cap: ${capping.join(', ')} allows only one citizenship (no dual).`
            : `Citizenship cap: ${capping.join(', ')} limits total citizenships to ${cap}.`);
        }
        for (const s of selected) {
          const sel = PASSPORTS.get(s);
          if (sel.incompatibleWith.size) {
            const names = Array.from(sel.incompatibleWith).filter(c => PASSPORTS.has(c)).map(c => PASSPORTS.get(c).name);
            if (names.length) lines.push(`${sel.name} is incompatible with: ${names.join(', ')}.`);
          }
          if (sel.notes) lines.push(`${sel.name}: ${sel.notes}`);
        }
        notesEl.innerHTML = lines.length
          ? `<ul>${lines.map(l => `<li>${l}</li>`).join('')}</ul>`
          : `<span class="muted">No active restrictions. Select passports to see notes.</span>`;
      }

      function updateCheckboxStates() {
        const items = listEl.querySelectorAll('li');
        const minCap = currentMaxAllowedCount();

        items.forEach(li => {
          const code = li.getAttribute('data-code');
          const label = li.querySelector('label');
          const input = li.querySelector('input');
          const alreadySelected = selected.has(code);

          let disable = false;
          if (!alreadySelected) {
            if (selected.size > 0) {
              if (selected.size >= minCap) disable = true;
              else if (!isCompatibleToAdd(code)) disable = true;
            }
            if (!disable) {
              for (const s of selected) {
                const sel = PASSPORTS.get(s);
                if (sel.incompatibleWith.has(code) || PASSPORTS.get(code).incompatibleWith.has(s)) { disable = true; break; }
              }
            }
          }
          input.disabled = disable;
          label.classList.toggle('disabled', disable && !alreadySelected);
        });
      }

      /* REPLACE: union of destination CODES (strings) */
function computeDestinationsUnion() {
  const union = new Set();
  selected.forEach(code => {
    const p = PASSPORTS.get(code);
    if (p) p.visaFree.forEach(destCode => union.add(destCode));
  });
  return Array.from(union).sort((a,b)=>a.localeCompare(b));
}

/* ADD: helper to display a destination code nicely */
function nameFor(code) {
  const up = (code || '').toUpperCase();
  // Prefer known passports' names; fall back to registry; else show code
  return PASSPORTS.get(up)?.name || CODE_TO_NAME[up] || up;
}
      function renderResults() {
  const chosen = Array.from(selected).map(c => PASSPORTS.get(c).name).sort((a,b)=>a.localeCompare(b));
  selectedEl.innerHTML = chosen.length
    ? `Selected: ${chosen.map(n => `<span class="pill">${n}</span>`).join(' ')}`
    : `<span class="muted">No passports selected.</span>`;

  const unionCodes = computeDestinationsUnion();
  summaryEl.innerHTML = `<b>${unionCodes.length}</b> countries available.`;

  destEl.innerHTML = unionCodes.length
    ? unionCodes.map(code => `<li>${nameFor(code)}</li>`).join('')
    : `<li class="muted">Destinations will appear here.</li>`;
}

      function recompute() {
        updateCheckboxStates();
        explainDisabledReasons();
        renderResults();
      }

      function applySearchFilter() {
        const filter = (searchEl.value || '').toLowerCase().trim();
        Array.from(listEl.querySelectorAll('li')).forEach(li => {
          const text = li.getAttribute('data-name') || '';
          li.style.display = text.includes(filter) ? '' : 'none';
        });
      }

      // Initial render & wire-up
      renderCountryList();
      applySearchFilter();
      recompute();
      searchEl.addEventListener('input', applySearchFilter);

      /* ===== Draggable dividers ===== */
      function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

      const dragX = document.getElementById('drag-bar-x');
      dragX.addEventListener('mousedown', e => {
        e.preventDefault();
        function onMove(ev){
          const rect = grid.getBoundingClientRect();
          const x = ev.clientX - rect.left;
          const min = 220, max = Math.min(720, rect.width - 320);
          grid.style.gridTemplateColumns = clamp(x, min, max) + 'px 5px 1fr';
        }
        function onUp(){ document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); }
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      });

      const dragY = document.getElementById('drag-bar-y');
      dragY.addEventListener('mousedown', e => {
        e.preventDefault();
        function onMove(ev){
          const rect = grid.getBoundingClientRect();
          const y = ev.clientY - rect.top;
          const minTop = 120, minBottom = 160, total = rect.height;
          grid.style.gridTemplateRows = clamp(y, minTop, total - minBottom) + 'px 5px 1fr';
        }
        function onUp(){ document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); }
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      });
    });
  })();
  </script>
</body>
</html>